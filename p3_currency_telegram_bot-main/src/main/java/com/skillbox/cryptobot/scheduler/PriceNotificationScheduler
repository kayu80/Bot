package com.skillbox.cryptobot.scheduler;

import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Component;
import com.skillbox.cryptobot.model.Subscriber;
import com.skillbox.cryptobot.repository.SubscriberRepository;
import com.skillbox.cryptobot.service.CryptoCurrencyService;
import org.telegram.telegrambots.meta.api.methods.send.SendMessage;
import org.telegram.telegrambots.meta.api.objects.Message;
import org.telegram.telegrambots.meta.bots.AbsSender;

import java.util.List;

@Component
@Slf4j
public class PriceNotificationScheduler {

    @Autowired
    private CryptoCurrencyService cryptoService;

    @Autowired
    private SubscriberRepository subscriberRepo;

    @Autowired
    private AbsSender absSender;

    @Scheduled(fixedDelay = 120000)
    public void checkForNotifications() {
        log.info("–ù–∞—á–∏–Ω–∞—é –ø—Ä–æ–≤–µ—Ä–∫—É —Ü–µ–Ω...");

        double currentPrice = cryptoService.getBitcoinPrice();

        List<Subscriber> subscribers = subscriberRepo.findAll();

        for (Subscriber subscriber : subscribers) {
            if (subscriber.getDesiredPrice() != null &&
                    subscriber.getDesiredPrice() > currentPrice) {

                SendMessage message = new SendMessage();
                message.setChatId(subscriber.getTelegramId());
                message.setText("üí• –¶–µ–Ω–∞ –±–∏—Ç–∫–æ–∏–Ω–∞ —É–ø–∞–ª–∞ –Ω–∏–∂–µ –≤–∞—à–µ–π —Ü–µ–ª–∏ ($" + subscriber.getDesiredPrice() + ") üöÄ\n–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞: $" + currentPrice);

                try {
                    absSender.execute(message);
                } catch (Exception e) {
                    log.error("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: ", e);
                }
            }
        }
    }
}
